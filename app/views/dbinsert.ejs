<%- contentFor('HeaderCss') %>
    <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå DataTables CSS ‡πÅ‡∏•‡∏∞ Bootstrap -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <style>
        #main-container {
            width: 100%;
            display: flex;
            transition: all 0.3s ease-in-out;
        }

        #table-container {
            width: 100%;
            transition: width 0.3s ease-in-out;
        }

        #preview-container {
            width: 0;
            transition: width 0.3s ease-in-out;
        }

        .show-preview #table-container {
            width: 50%;
        }

        .show-preview #preview-container {
            width: 50%;
            display: block !important;
        }

        .preview-header {
            display: flex;
            justify-content: flex-end;
            padding: 10px;
            background: #f8f9fa;
        }
    </style>

    <%- contentFor('body') %>
        <div class="container-fluid mt-2">
            <h1 class="text-center mb-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å CSV</h1>

            <div class="alert alert-info">
                <strong>Auction:</strong>
                <%= auctionSelect %><br>
                    <strong>Subfolder:</strong>
                    <%= subfolderSelect %><br>
                        <strong>CSV File:</strong>
                        <%= csvSelect %>
                            <div class="d-flex justify-content-between">
                                <button id="insertCsvBtn" class="btn btn-primary mt-4" <%=Checkinsert? "disabled" : ""
                                    %>>Insert to Database</button>
                            </div>
            </div>

            <div id="main-container" class="d-flex">
                <!-- ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ã‡πâ‡∏≤‡∏¢: ‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
                <div id="table-container" class="flex-grow-1">
                    <div class="d-flex justify-content-between">
                        <button id="reload" class="btn btn-primary mt-3"
                            onclick="window.location.reload();">Retable</button>
                        <button id="deleteAllButton" class="btn btn-danger mt-3">Delete All (Search Results)</button>
                    </div>
                    <form id="csvForm" action="/db-upload/savecsv" method="POST">
                        <button id="saveCsvBtn" type="submit" class="btn btn-success mt-4 mb-3">Save Changes</button>
                        <input type="hidden" name="auction" value="<%= auctionSelect %>">
                        <input type="hidden" name="subfolder" value="<%= subfolderSelect %>">
                        <input type="hidden" name="csvFile" value="<%= csvSelect %>">

                        <table id="csvTable" class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllCheckbox"></th>
                                    <th>‡∏•‡∏ö</th>
                                    <% const columns=Object.keys(csvData[0]); const downloadCols=columns.filter(col=>
                                        csvData.some(row => row[col].startsWith("downloads/")));
                                        const bankCols = columns.filter(col => col === "bank");
                                        const otherCols = columns.filter(col => !downloadCols.includes(col) && col !==
                                        "bank");
                                        const orderedCols = [...downloadCols, ...bankCols, ...otherCols];
                                        %>
                                        <% orderedCols.forEach(col=> { %>
                                            <th>
                                                <%= col %>
                                            </th>
                                            <% }); %>
                                </tr>
                            </thead>
                            <tbody>
                                <% csvData.forEach((row, rowIndex)=> { %>
                                    <tr>
                                        <td class="text-center">
                                            <input type="checkbox" value="<%= rowIndex %>" class="rowCheckbox">
                                        </td>
                                        <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß -->
                                        <td class="text-center">
                                            <button type="button" class="btn btn-danger btn-sm"
                                                onclick="removeRow(<%= rowIndex %>)">
                                                <i class="ri-delete-bin-line"></i>
                                            </button>
                                        </td>
                                        <% orderedCols.forEach(col=> { %>
                                            <td class="text-center">
                                                <div style="display: none;">
                                                    <%= row[col] %>
                                                </div>
                                                <% if (row[col] && row[col].startsWith("downloads/")) { %>
                                                    <a href="#" class="btn btn-link d-inline-flex align-items-center"
                                                        onclick="openPreview('<%= row[col] %>', this); return false;">
                                                        <i class="ri-search-line me-1"></i>
                                                        <%= row[col].includes('pdf') ? "PDF" : "Image" %>
                                                    </a>
                                                    <input type="hidden" name="data[<%= rowIndex %>][<%= col %>]"
                                                        value="<%= row[col] %>">
                                                    <% } else { %>
                                                        <input type="text" name="data[<%= rowIndex %>][<%= col %>]"
                                                            value="<%= row[col] %>">
                                                        <% } %>
                                            </td>
                                            <% }); %>
                                    </tr>
                                    <% }); %>
                            </tbody>
                        </table>
                    </form>
                </div>

                <!-- ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡∏ß‡∏≤: ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏ü‡∏•‡πå Download -->
                <div id="preview-container" class="d-none">
                    <div class="preview-header">
                        <button onclick="closePreview()" class="btn btn-danger">Close</button>
                    </div>
                    <iframe id="previewFrame" src="" style="width: 100%; height: 100%; border: none;"></iframe>
                </div>
            </div>

            <script>
                function openPreview(fileUrl, link) {
                    document.getElementById('previewFrame').src = fileUrl;
                    // ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
                    document.getElementById('main-container').classList.add('show-preview');
                    // ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏î
                    let row = link.closest('tr');
                    document.querySelectorAll("#csvTable tbody tr").forEach(tr => tr.classList.remove('table-warning'));
                    row.classList.add('table-warning');
                }

                function closePreview() {
                    document.getElementById('main-container').classList.remove('show-preview');
                    // ‡∏•‡∏ö‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏î
                    document.querySelectorAll("#csvTable tbody tr").forEach(tr => tr.classList.remove('table-warning'));
                }

                function removeRow(rowIndex) {
                    // ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏à‡∏≤‡∏Å DataTable
                    const table = $('#csvTable').DataTable(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å DataTable instance
                    table.row(rowIndex).remove().draw(); // ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï DataTable
                }



            </script>
            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    // ‚úÖ Initialize DataTable
                    const table = new DataTable("#csvTable", {
                        scrollX: true,
                        responsive: true,
                        searching: true,
                        ordering: true,
                        lengthMenu: [10, 25, 50, 100],
                    });

                    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                    const deleteAllButton = document.getElementById("deleteAllButton");

                    selectAllCheckbox.addEventListener('change', function () {
                        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        const checked = selectAllCheckbox.checked;
                        table.rows({ search: 'applied' }).nodes().to$().find('.rowCheckbox').prop('checked', checked);
                    });

                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                    deleteAllButton.addEventListener("click", function () {
                        if (confirm("Are you sure you want to delete all rows from search results?")) {
                            // ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                            const rowsToDelete = table.rows({ search: 'applied' }).nodes().to$().filter(function () {
                                return $(this).find('.rowCheckbox').prop('checked'); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ checkbox ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                            });

                            // ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                            rowsToDelete.each(function () {
                                const rowIndex = $(this).index(); // ‡∏î‡∏∂‡∏á index ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß
                                table.row(rowIndex).remove().draw(); // ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï DataTable
                            });
                        }
                    });

                    const form = document.getElementById("csvForm");
                    const saveCsvBtn = document.getElementById("saveCsvBtn");

                    if (form && saveCsvBtn) {
                        saveCsvBtn.addEventListener("click", function (event) {
                            event.preventDefault(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ submit ‡∏õ‡∏Å‡∏ï‡∏¥
                            // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å hidden input
                            const auction = document.querySelector("input[name='auction']").value;
                            const subfolder = document.querySelector("input[name='subfolder']").value;
                            const csvFile = document.querySelector("input[name='csvFile']").value;
                            // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á DataTable
                            const data = [];
                            table.rows().every(function () {
                                const rowNode = this.node();
                                const rowData = {};
                                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏•‡∏ö
                                if (rowNode) {
                                    rowNode.querySelectorAll("input").forEach((input) => {
                                        rowData[input.name.split("][").pop().replace("]", "")] = input.value;
                                    });
                                    data.push(rowData);
                                }
                            });
                            // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á JSON Object ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö `req.body`
                            const formDataObj = {
                                auction,
                                subfolder,
                                csvFile,
                                data,
                            };
                            console.log("üì§ Sending Data:", formDataObj);
                            // ‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö JSON ‡∏î‡πâ‡∏ß‡∏¢ fetch API
                            fetch(form.action, {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify(formDataObj),
                            })
                                .then((response) => response.json())
                                .then((data) => {
                                    if (data.message) {
                                        alert(`${data.message}`);
                                    } else {
                                        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                                    }
                                    console.log("üì• Server Response:", data);

                                })
                                .catch((error) => {
                                    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!");
                                    console.error("üö® Error:", error);
                                });
                        });

                    }
                });

                document.getElementById('insertCsvBtn').addEventListener('click', async function () {
                    const auction = '<%= auctionSelect %>';
                    const subfolder = '<%= subfolderSelect %>';
                    const csvFile = '<%= csvSelect %>';

                    if (!auction || !subfolder || !csvFile) {
                        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Auction, Subfolder ‡πÅ‡∏•‡∏∞ CSV');
                        return;
                    }
                    if (confirm('Are you sure you want to Insert ?')) {
                        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á backend
                        try {
                            const response = await fetch('/db-upload/insertcsv', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ auction, subfolder, csvFile })
                            });

                            const result = await response.text(); // ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå

                            alert(result); // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô Alert
                            window.location.reload();
                        } catch (error) {
                            console.error('Error:', error);
                            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                        }
                    }
                });

            </script>

            <%- contentFor('FooterJs') %>
                <!-- ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå jQuery ‡πÅ‡∏•‡∏∞ DataTables JS -->
                <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>